{"version":3,"sources":["../../../src/providers/http.test.ts"],"names":["decode","encode","fromHex","toHex","network","ethers","waffle","JsonRpcServer","ETHER_BALANCES_ID","ETHER_BALANCES_TYPE","TOKEN_BALANCES_ID","TOKEN_BALANCES_TYPE","fixture","withId","HttpProvider","createFixtureLoader","provider","isProvider","send","loadFixture","getWallets","server","hostname","port","beforeAll","listen","afterAll","close","describe","it","expect","toBe","url","contract","addresses","data","response","to","address","results","i","length","balance","getBalance","success","value","toHexString","slice","padStart","token","mock","balanceOf","returns"],"mappings":"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","sourcesContent":["import { decode, encode, fromHex, toHex } from '@findeth/abi';\nimport { network, ethers, waffle } from 'hardhat';\nimport { JsonRpcServer } from 'hardhat/internal/hardhat-network/jsonrpc/server';\nimport { ETHER_BALANCES_ID, ETHER_BALANCES_TYPE, TOKEN_BALANCES_ID, TOKEN_BALANCES_TYPE } from '../constants';\nimport { fixture } from '../eth-scan.test';\nimport { Result } from '../types';\nimport { withId } from '../utils';\nimport HttpProvider from './http';\n\nconst { createFixtureLoader, provider } = waffle;\nconst { isProvider, send } = HttpProvider;\n\nconst loadFixture = createFixtureLoader(provider.getWallets(), provider);\n\nconst server = new JsonRpcServer({\n  hostname: '127.0.0.1',\n  port: 8547,\n  provider: network.provider\n});\n\nbeforeAll(async () => {\n  await server.listen();\n}, 100000);\n\nafterAll(async () => {\n  await server.close();\n});\n\ndescribe('isProvider', () => {\n  it('checks if a provider is an HTTP provider', () => {\n    expect(isProvider('https://foo')).toBe(true);\n    expect(\n      isProvider({\n        url: 'https://foo'\n      })\n    ).toBe(true);\n    expect(isProvider({})).toBe(false);\n  });\n});\n\ndescribe('send', () => {\n  it('gets the Ether balances from the contract', async () => {\n    const { contract, addresses } = await loadFixture(fixture);\n\n    const data = withId(ETHER_BALANCES_ID, encode(ETHER_BALANCES_TYPE, [addresses]));\n    const response = await send<string>('http://127.0.0.1:8547', 'eth_call', [{ to: contract.address, data }]);\n\n    const results = decode(['(bool,bytes)[]'], fromHex(response))[0] as Result[];\n\n    for (let i = 0; i < addresses.length; i++) {\n      const balance = await ethers.provider.getBalance(addresses[i]);\n      const [success, value] = results[i];\n\n      expect(success).toBe(true);\n      expect(toHex(value)).toBe(balance.toHexString().slice(2).padStart(64, '0'));\n    }\n  });\n\n  it('gets the token balances from the contract', async () => {\n    const { contract, addresses, token } = await loadFixture(fixture);\n    await token.mock.balanceOf.returns('1000');\n\n    const data = withId(TOKEN_BALANCES_ID, encode(TOKEN_BALANCES_TYPE, [addresses, token.address]));\n    const response = await send<string>('http://127.0.0.1:8547', 'eth_call', [{ to: contract.address, data }]);\n\n    const results = decode(['(bool,bytes)[]'], fromHex(response))[0] as Result[];\n\n    for (let i = 0; i < addresses.length; i++) {\n      const [success, value] = results[i];\n\n      expect(success).toBe(true);\n      expect(toHex(value)).toBe('00000000000000000000000000000000000000000000000000000000000003e8');\n    }\n  });\n});\n"],"file":"http.test.js"}